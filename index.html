<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Identification App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root { font-family: 'Inter', sans-serif; }
        /* Style the file input button for better aesthetics */
        .custom-file-input {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
            background-color: #f0f4f8;
            color: #1f2937;
        }
        .custom-file-input:hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="text-center mb-8 p-4 bg-white shadow-lg rounded-xl flex justify-between items-center">
            <div>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800">Employee ID Registry</h1>
                <p class="text-gray-600 mt-1 hidden sm:block">Enrollment and Verification System</p>
            </div>
            <div id="authPanel">
                <p id="userIdDisplay" class="text-sm text-gray-500 mt-2"></p>
                <p id="roleDisplay" class="text-sm font-bold text-green-600"></p>
                <button id="signOutButton" onclick="handleSignOut()" class="hidden mt-2 px-3 py-1 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition">Sign Out</button>
            </div>
        </header>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center py-12 text-blue-600 hidden">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-lg">Initializing app and checking user status...</p>
        </div>
        
        <!-- Login/Sign Up Form (Visible initially) -->
        <div id="authScreen" class="max-w-md mx-auto bg-white p-8 shadow-xl rounded-xl">
            <h2 class="text-2xl font-semibold mb-4 text-blue-700 border-b pb-2">Sign In or Create Account</h2>
            <p id="authMessage" class="mb-4 text-sm text-red-500 hidden"></p>
            <p class="mb-4 text-sm text-gray-600">Please sign in to access the Employee Registry. If this is the first time, your account will be automatically set as **Super Admin**.</p>
            
            <form id="authForm" onsubmit="handleAuthSubmit(event)">
                <div class="mb-4">
                    <label for="authEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="authEmail" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="authPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="authPassword" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="signInButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Sign In / Register
                </button>
            </form>
        </div>


        <!-- Main Application Content (Hidden until logged in) -->
        <div id="mainContent" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">

            <!-- 1. Enrollment & Management Section (Conditional Access) -->
            <div class="lg:col-span-1 bg-white p-6 shadow-xl rounded-xl h-fit">
                <h2 class="text-2xl font-semibold mb-4 text-blue-700 border-b pb-2">Admin Tools</h2>

                <!-- Tab Navigation -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button class="tab-button py-2 px-4 text-sm font-medium border-b-2 transition duration-150" data-tab="single" onclick="changeTab('single')">Single Entry</button>
                    <button class="tab-button py-2 px-4 text-sm font-medium border-b-2 transition duration-150" data-tab="bulk" onclick="changeTab('bulk')">Bulk Data Entry</button>
                    <button class="tab-button py-2 px-4 text-sm font-medium border-b-2 transition duration-150" data-tab="usermanagement" onclick="changeTab('usermanagement')">User Management</button>
                </div>
                
                <!-- Tab Content: User Management -->
                <div id="tab-usermanagement" class="tab-content" style="display: none;">
                    <h3 class="text-xl font-medium mb-3">Create New User Account</h3>
                    <p class="text-sm text-gray-500 mb-4" id="userMgmtIntro"></p>
                    <form id="userCreationForm" onsubmit="handleUserCreation(event)">
                        <div class="mb-4">
                            <label for="newEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="newEmail" required class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-4">
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">Password (Min 6 chars)</label>
                            <input type="password" id="newPassword" required class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-6">
                            <label for="newRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                            <select id="newRole" required class="w-full p-2 border border-gray-300 rounded-lg">
                                <!-- Options will be populated based on the logged-in user's role -->
                            </select>
                        </div>
                        <button type="submit" id="userCreationButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Create Account
                        </button>
                        <p id="userCreationMessage" class="mt-3 text-center text-sm font-medium"></p>
                    </form>
                </div>


                <!-- Tab Content: Single Entry -->
                <div id="tab-single" class="tab-content" style="display: none;">
                    <p class="text-sm text-gray-500 mb-4">The **Serial ID** will be auto-generated.</p>
                    <form id="enrollmentForm" onsubmit="handleSingleEnrollment(event)">
                        
                        <div class="mb-4">
                            <label for="employeeIdOptional" class="block text-sm font-medium text-gray-700 mb-1">Optional Employee ID (Manual ID)</label>
                            <input type="text" id="employeeIdOptional" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label for="englishName" class="block text-sm font-medium text-gray-700 mb-1">English Name (EITHER/OR required)</label>
                            <input type="text" id="englishName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="mb-4">
                            <label for="bengaliName" class="block text-sm font-medium text-gray-700 mb-1">Bengali Name (বাংলা নাম) (EITHER/OR required)</label>
                            <input type="text" id="bengaliName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 font-serif">
                        </div>
                        
                        <div class="mb-4">
                            <label for="designation" class="block text-sm font-medium text-gray-700 mb-1">Designation</label>
                            <input type="text" id="designation" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label for="factoryName" class="block text-sm font-medium text-gray-700 mb-1">Factory Name</label>
                            <input type="text" id="factoryName" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="mb-4">
                            <label for="nationalId" class="block text-sm font-medium text-gray-700 mb-1">National ID / Birth Certificate No. (Optional)</label>
                            <input type="text" id="nationalId" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>


                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload Employee Photo</label>
                            <input type="file" id="photoFile" accept="image/*" required onchange="previewImage(event)" class="hidden">
                            <label for="photoFile" class="custom-file-input">Choose File</label>
                            
                            <!-- Image Preview -->
                            <div class="mt-3 w-32 h-32 border border-dashed border-gray-400 rounded-lg overflow-hidden flex items-center justify-center bg-gray-100">
                                <img id="imagePreview" src="https://placehold.co/128x128/f3f4f6/9ca3af?text=Photo" alt="Preview" class="w-full h-full object-cover">
                            </div>
                        </div>

                        <button type="submit" id="enrollButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Enroll Employee
                        </button>
                        <p id="enrollmentMessage" class="mt-3 text-center text-sm font-medium"></p>
                    </form>
                </div>

                <!-- Tab Content: Bulk Entry (CSV File Upload) -->
                <div id="tab-bulk" class="tab-content" style="display: none;">
                    <p class="text-sm text-gray-500 mb-4">Upload a **CSV file**. The file **must** contain six columns in this exact order: <code class="bg-gray-200 p-1 rounded">Optional Employee ID, English Name, Bengali Name, Designation, Factory Name, National ID/Birth Cert. No.</code> The **Serial ID** will be auto-generated.</p>
                    <form id="bulkForm" onsubmit="handleBulkEnrollment(event)">
                        <div class="mb-4">
                            <label for="csvFile" class="block text-sm font-medium text-gray-700 mb-1">Select CSV File (.csv)</label>
                            <input type="file" id="csvFile" accept=".csv" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <button type="submit" id="bulkButton" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Process Bulk Data from CSV
                        </button>
                        <p id="bulkMessage" class="mt-3 text-center text-sm font-medium"></p>
                    </form>
                </div>
            </div>

            <!-- 2. Search/Verification Section (2/3 width on desktop) -->
            <div class="lg:col-span-2 bg-white p-6 shadow-xl rounded-xl">
                <h2 class="text-2xl font-semibold mb-4 text-blue-700 border-b pb-2">Search & Verification (Find)</h2>

                <div class="mb-6">
                    <label for="searchQuery" class="block text-sm font-medium text-gray-700 mb-1">Search by Name, Serial ID, Optional ID, Designation, or Factory</label>
                    <input type="text" id="searchQuery" oninput="filterEmployees()" placeholder="Type a name, ID, designation, or factory to search..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div id="employeeList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Employee cards will be injected here -->
                    <p id="emptyMessage" class="text-center col-span-full text-gray-500 mt-4 hidden">No employees found. Enroll one above!</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let storage;
        let userId = null; 
        let currentUserRole = null;
        let employees = []; 
        let lastSerialId = 0; 

        // Environment variables (MUST be defined for Canvas runtime)
        const appId = 'employeeverification-6b271'; // Using project ID as a fallback for app_id
        
        // ** USER-PROVIDED FIREBASE CONFIGURATION **
        const firebaseConfig = {
			  apiKey: "AIzaSyD2e80GQoeqoFmnaLtGmkR8_cUpsEnD0Gs",
			  authDomain: "employeeverification-d7aa7.firebaseapp.com",
			  projectId: "employeeverification-d7aa7",
			  storageBucket: "employeeverification-d7aa7.firebasestorage.app",
			  messagingSenderId: "341298369579",
			  appId: "1:341298369579:web:976ac201128fb4cc22c66e"
			};
        // ** END USER-PROVIDED FIREBASE CONFIGURATION **

        // Firestore Path Constants
        const EMPLOYEE_COLLECTION_PATH = `artifacts/${appId}/public/data/employees`;
        const USER_ROLES_COLLECTION_PATH = `artifacts/${appId}/public/data/user_roles`;
        const SETUP_DOC_PATH = `artifacts/${appId}/public/data/setup/status`;


        // UI elements
        const loadingElement = document.getElementById('loading');
        const emptyMessage = document.getElementById('emptyMessage');
        const employeeList = document.getElementById('employeeList');
        const enrollButton = document.getElementById('enrollButton');
        const enrollmentMessage = document.getElementById('enrollmentMessage');
        const bulkButton = document.getElementById('bulkButton');
        const bulkMessage = document.getElementById('bulkMessage');
        const authScreen = document.getElementById('authScreen');
        const mainContent = document.getElementById('mainContent');
        const authMessage = document.getElementById('authMessage');
        const signOutButton = document.getElementById('signOutButton');
        const roleDisplay = document.getElementById('roleDisplay');
        const userMgmtIntro = document.getElementById('userMgmtIntro');
        const newRoleSelect = document.getElementById('newRole');


        // --- Core App Initialization & Auth ---

        /**
         * Initializes Firebase and sets up the Auth state listener.
         */
        async function initFirebase() {
            loadingElement.classList.remove('hidden');

            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                loadingElement.innerHTML = '<p class="text-red-500">Firebase configuration error. Cannot initialize app.</p>';
                return;
            }

            try {
                // 1. Initialize Firebase services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                setLogLevel('Debug'); // Enable debug logging

                // 2. Set up Auth state listener
                onAuthStateChanged(auth, async (user) => {
                    loadingElement.classList.add('hidden');
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `UID: ${userId.substring(0, 8)}...`;
                        await checkUserRole(user.uid);
                    } else {
                        userId = null;
                        currentUserRole = null;
                        document.getElementById('userIdDisplay').textContent = 'Not Signed In';
                        roleDisplay.textContent = '';
                        // Show Auth screen and hide main content
                        authScreen.classList.remove('hidden');
                        mainContent.classList.add('hidden');
                        signOutButton.classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingElement.innerHTML = `<p class="text-red-500">Initialization failed: ${error.message}</p>`;
            } 
        }

        /**
         * Checks the user's role in Firestore and updates the UI accordingly.
         * @param {string} uid - The Firebase Auth User ID.
         */
        async function checkUserRole(uid) {
            try {
                const roleDocRef = doc(db, USER_ROLES_COLLECTION_PATH, uid);
                const docSnap = await getDoc(roleDocRef);

                if (docSnap.exists()) {
                    currentUserRole = docSnap.data().role;
                } else {
                    // Check if this is the very first user being registered (Super Admin Setup)
                    const setupStatusRef = doc(db, SETUP_DOC_PATH);
                    const setupStatusSnap = await getDoc(setupStatusRef);
                    const isSetupComplete = setupStatusSnap.exists() && setupStatusSnap.data().isComplete;
                    
                    if (!isSetupComplete) {
                         // First user, grant Super Admin role and mark setup complete
                         await setDoc(roleDocRef, { role: 'super_admin' });
                         await setDoc(setupStatusRef, { isComplete: true, initialAdminId: uid, createdAt: serverTimestamp() });
                         currentUserRole = 'super_admin';
                         authMessage.textContent = 'Welcome! You have been assigned the Super Admin role.';
                         authMessage.className = 'mt-3 text-center text-sm font-medium text-green-600';
                    } else {
                        // User exists in auth but somehow lost role (fallback to regular user)
                        await setDoc(roleDocRef, { role: 'user' });
                        currentUserRole = 'user';
                    }
                }
                
                roleDisplay.textContent = `Role: ${currentUserRole.toUpperCase().replace('_', ' ')}`;

                // Hide Auth screen and show main content
                authScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                signOutButton.classList.remove('hidden');
                
                // Configure Admin Tools based on role
                configureAdminTools(currentUserRole);

                // FIX: Load data only AFTER the user is authenticated and role is known
                loadEmployees(); 
                changeTab('single');

            } catch (error) {
                console.error("Error fetching user role:", error);
                roleDisplay.textContent = 'Role Error';
            }
        }

        /**
         * Handles Sign In or Sign Up based on attempt.
         */
        window.handleAuthSubmit = async function(event) {
            event.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            authMessage.textContent = 'Authenticating...';
            authMessage.classList.remove('hidden', 'text-green-600');
            authMessage.classList.add('text-blue-600');

            try {
                // 1. Try to sign in
                await signInWithEmailAndPassword(auth, email, password);
                authMessage.textContent = 'Sign in successful. Checking role...';
            } catch (signInError) {
                if (signInError.code === 'auth/user-not-found' || signInError.code === 'auth/wrong-password') {
                    // 2. If sign in fails, try to create account (if this is the first user)
                    try {
                        const setupStatusRef = doc(db, SETUP_DOC_PATH);
                        const setupStatusSnap = await getDoc(setupStatusRef);
                        const isSetupComplete = setupStatusSnap.exists() && setupStatusSnap.data().isComplete;

                        if (isSetupComplete) {
                            // Setup complete, user must be created by an Admin
                             authMessage.textContent = 'Incorrect credentials. New users must be created by an Admin first.';
                             authMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                        } else {
                            // First user, allow sign up and auto-assign Super Admin role
                            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            // Role assignment and setup completion done in checkUserRole
                            authMessage.textContent = 'Account created successfully. Assigning Super Admin role...';
                        }
                    } catch (signUpError) {
                         authMessage.textContent = `Authentication failed: ${signUpError.message}`;
                         authMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                    }
                } else {
                    authMessage.textContent = `Authentication failed: ${signInError.message}`;
                    authMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                }
            }
        }

        /**
         * Handles user sign-out.
         */
        window.handleSignOut = async function() {
            try {
                await signOut(auth);
                console.log("User signed out.");
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }

        /**
         * Configures the enrollment and user management tabs based on the user's role.
         * @param {string} role - The current user's role.
         */
        function configureAdminTools(role) {
            const tabs = document.querySelectorAll('.tab-button');
            const enrollmentForm = document.getElementById('enrollmentForm');
            const bulkForm = document.getElementById('bulkForm');
            const userMgmtTabButton = document.querySelector('[data-tab="usermanagement"]');
            
            // 1. Reset visibility for all admin tabs
            tabs.forEach(btn => btn.style.display = 'none');

            if (role === 'super_admin' || role === 'admin') {
                // Admins and Super Admins see Enrollment/Bulk tabs
                document.querySelector('[data-tab="single"]').style.display = 'block';
                document.querySelector('[data-tab="bulk"]').style.display = 'block';
                
                // 2. Set User Management tab visibility and content
                userMgmtTabButton.style.display = 'block';
                
                if (role === 'super_admin') {
                    userMgmtIntro.textContent = 'As Super Admin, you can create new Admin or Regular User accounts.';
                    newRoleSelect.innerHTML = `
                        <option value="admin">Admin</option>
                        <option value="user">User (Basic Access)</option>
                    `;
                } else if (role === 'admin') {
                    userMgmtIntro.textContent = 'As Admin, you can only create new Regular User accounts.';
                    newRoleSelect.innerHTML = `<option value="user">User (Basic Access)</option>`;
                }
                
                // changeTab('single'); // Handled now in checkUserRole
            } else {
                // Regular Users only see the Search panel
                document.getElementById('adminToolsWarning').textContent = 'You do not have permission to access enrollment tools.';
                mainContent.classList.remove('hidden'); // Ensure search is visible
                // changeTab('search'); // Handled now in checkUserRole
            }
        }

        /**
         * Handles creation of new users by Super Admins or Admins.
         */
        window.handleUserCreation = async function(event) {
            event.preventDefault();
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;
            
            const msgElement = document.getElementById('userCreationMessage');
            
            if (currentUserRole !== 'super_admin' && (currentUserRole !== 'admin' || role !== 'user')) {
                msgElement.textContent = `Permission denied. You cannot create a user with the role ${role}.`;
                msgElement.className = 'mt-3 text-center text-sm font-medium text-red-600';
                return;
            }

            if (password.length < 6) {
                msgElement.textContent = 'Password must be at least 6 characters.';
                msgElement.className = 'mt-3 text-center text-sm font-medium text-red-600';
                return;
            }

            document.getElementById('userCreationButton').disabled = true;
            msgElement.textContent = 'Creating user...';
            msgElement.className = 'mt-3 text-center text-sm font-medium text-blue-600';

            try {
                // 1. Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUid = userCredential.user.uid;
                
                // 2. Set the role in Firestore
                const roleDocRef = doc(db, USER_ROLES_COLLECTION_PATH, newUid);
                await setDoc(roleDocRef, { role: role, createdBy: userId, createdAt: serverTimestamp() });
                
                msgElement.textContent = `Successfully created ${role.toUpperCase()} account for ${email}!`;
                msgElement.className = 'mt-3 text-center text-sm font-medium text-green-600';
                document.getElementById('userCreationForm').reset();
            } catch (error) {
                msgElement.textContent = `User creation failed: ${error.message}`;
                msgElement.className = 'mt-3 text-center text-sm font-medium text-red-600';
            } finally {
                document.getElementById('userCreationButton').disabled = false;
            }
        }

        // --- UI Functions (Tabs & Preview) ---

        /**
         * Switches between the Single Entry and Bulk Entry tabs.
         * @param {string} tabName - 'single', 'bulk', or 'usermanagement'.
         */
        window.changeTab = function(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            const requiredRoles = {
                'single': ['super_admin', 'admin'],
                'bulk': ['super_admin', 'admin'],
                'usermanagement': ['super_admin', 'admin']
            };

            tabs.forEach(tab => {
                tab.style.display = 'none';
            });
            buttons.forEach(button => {
                button.classList.remove('border-blue-600', 'text-blue-600', 'font-bold');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            // Role check before showing content
            if (requiredRoles[tabName] && !requiredRoles[tabName].includes(currentUserRole)) {
                 // Prevent showing the tab content if role doesn't match
                 return;
            }

            const targetTab = document.getElementById(`tab-${tabName}`);
            const targetButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);

            if (targetTab) targetTab.style.display = 'block';
            if (targetButton) {
                targetButton.classList.add('border-blue-600', 'text-blue-600', 'font-bold');
                targetButton.classList.remove('border-transparent', 'text-gray-500');
            }
        }

        /**
         * Previews the selected image file.
         */
        window.previewImage = function(event) {
            const reader = new FileReader();
            reader.onload = function(){
                const output = document.getElementById('imagePreview');
                output.src = reader.result;
            };
            if (event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            }
        }

        // --- Firestore & Display Functions (Unchanged core logic) ---

        /**
         * Converts employee data into an HTML card element.
         * @param {Object} employee - Employee document data.
         * @returns {string} HTML string for the employee card.
         */
        function createEmployeeCard(employee) {
            const uploadedBy = employee.userId === userId ? ' (You)' : '';
            const timestamp = employee.createdAt?.toDate ? employee.createdAt.toDate().toLocaleDateString() : 'N/A';
            
            const isPhotoMissing = employee.photoURL === 'N/A';
            const imageUrl = isPhotoMissing ? 
                `https://placehold.co/300x160/ef4444/ffffff?text=PHOTO+MISSING` : 
                employee.photoURL;
            const statusClass = isPhotoMissing ? 'border-red-500 bg-red-100' : 'border-blue-200 bg-blue-50';
            const statusText = isPhotoMissing ? '<span class="text-xs text-red-600 font-bold">⚠️ Photo Missing</span>' : '';
            const nationalIdDisplay = employee.nationalId || 'N/A';
            const optionalIdDisplay = employee.employeeIdOptional || 'N/A'; 
            const serialIdDisplay = employee.id || String(employee.serialId).padStart(6, '0');

            return `
                <div class="p-4 rounded-lg shadow-md hover:shadow-lg transition duration-200 border ${statusClass}">
                    <img src="${imageUrl}" alt="${employee.englishName}" class="w-full h-40 object-cover rounded-lg mb-3 border-2 border-blue-400" onerror="this.onerror=null;this.src='https://placehold.co/300x160/cbd5e1/1e3a8a?text=Image+Error'">
                    <h3 class="text-lg font-bold text-blue-800">${employee.englishName || employee.bengaliName}</h3>
                    <p class="text-md text-gray-700 font-serif mb-2">বাংলা নাম: ${employee.bengaliName || 'N/A'}</p>
                    <div class="text-sm space-y-1 text-gray-700 mt-2">
                        <p><strong class="text-red-600">Serial ID (Auto):</strong> ${serialIdDisplay}</p>
                        <p><strong class="text-blue-600">Employee ID (Optional):</strong> ${optionalIdDisplay}</p>
                        <p><strong class="text-blue-600">Designation:</strong> ${employee.designation}</p>
                        <p><strong class="text-blue-600">Factory:</strong> ${employee.factoryName}</p>
                        <p class="truncate"><strong class="text-blue-600">National ID:</strong> ${nationalIdDisplay}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        ${statusText}
                        <p>Uploaded: ${timestamp} ${uploadedBy}</p>
                    </div>
                </div>
            `;
        }

        /**
         * Filters the displayed employees based on the search query.
         */
        window.filterEmployees = function() {
            const query = document.getElementById('searchQuery').value.toLowerCase().trim();
            
            const filtered = employees.filter(emp => {
                const serialIdStr = String(emp.serialId);
                const optionalId = emp.employeeIdOptional ? emp.employeeIdOptional.toLowerCase() : '';
                const nationalId = emp.nationalId ? emp.nationalId.toLowerCase() : ''; // Also search by National ID
                
                return serialIdStr.includes(query) ||
                       optionalId.includes(query) ||
                       nationalId.includes(query) || 
                       emp.englishName.toLowerCase().includes(query) || 
                       emp.bengaliName.toLowerCase().includes(query) ||
                       emp.designation.toLowerCase().includes(query) ||
                       emp.factoryName.toLowerCase().includes(query);
            });

            employeeList.innerHTML = '';
            if (filtered.length === 0 && employees.length > 0) {
                employeeList.innerHTML = '<p class="text-center col-span-full text-red-500 font-medium mt-4">No matching records found.</p>';
                emptyMessage.classList.add('hidden');
            } else if (employees.length === 0) {
                 emptyMessage.classList.remove('hidden');
            } else {
                 filtered.forEach(emp => {
                    employeeList.innerHTML += createEmployeeCard(emp);
                });
                emptyMessage.classList.add('hidden');
            }
        }

        /**
         * Sets up real-time listener for the employees collection and updates lastSerialId.
         */
        function loadEmployees() {
            if (!db) return;
            
            const employeeQuery = query(collection(db, EMPLOYEE_COLLECTION_PATH));

            onSnapshot(employeeQuery, (snapshot) => {
                employees = [];
                let maxSerial = 0; // Track the highest serial ID
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const serialId = data.serialId || 0;
                    if (serialId > maxSerial) {
                        maxSerial = serialId;
                    }
                    employees.push(data);
                });
                
                // Sort by Serial ID descending for better visibility of new items
                employees.sort((a, b) => b.serialId - a.serialId);

                lastSerialId = maxSerial; // Update the global tracker
                
                // Re-render based on current search filter
                filterEmployees();
                
                console.log(`Loaded ${employees.length} employee records. Max Serial ID: ${lastSerialId}`);
            }, (error) => {
                console.error("Error fetching employees:", error);
            });
        }

        // --- Enrollment Handlers (Logic Protected by Auth/Role) ---

        /**
         * Handles the single enrollment form submission.
         */
        window.handleSingleEnrollment = async function(event) {
            event.preventDefault();
            
            if (!['super_admin', 'admin'].includes(currentUserRole)) {
                enrollmentMessage.textContent = 'Permission denied. Only Admins can enroll employees.';
                enrollmentMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                return;
            }
            
            const employeeIdOptional = document.getElementById('employeeIdOptional').value.trim();
            const englishName = document.getElementById('englishName').value.trim();
            const bengaliName = document.getElementById('bengaliName').value.trim();
            const designation = document.getElementById('designation').value.trim();
            const factoryName = document.getElementById('factoryName').value.trim();
            const nationalId = document.getElementById('nationalId').value.trim(); 
            const photoFile = document.getElementById('photoFile').files[0];
            
            if ((!englishName && !bengaliName) || !designation || !factoryName || !photoFile) {
                enrollmentMessage.textContent = 'Please fill all required fields (Name EITHER/OR, Designation, Factory, Photo).';
                enrollmentMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                return;
            }

            enrollButton.disabled = true;
            enrollButton.textContent = 'Uploading... Please wait.';
            enrollmentMessage.textContent = ''; 
            
            let existingEmployee = null;
            if (employeeIdOptional) {
                existingEmployee = employees.find(e => e.employeeIdOptional === employeeIdOptional);
            }

            let docId;
            let newSerialId;
            let action = 'Successfully enrolled';
            
            if (existingEmployee && existingEmployee.photoURL === 'N/A') {
                docId = existingEmployee.id; 
                newSerialId = existingEmployee.serialId;
                action = 'Updated photo for';
                enrollmentMessage.textContent = `Updating photo for existing Optional ID ${employeeIdOptional}...`;
                enrollmentMessage.className = 'mt-3 text-center text-sm font-medium text-orange-600';
            } else if (existingEmployee && existingEmployee.photoURL !== 'N/A') {
                enrollmentMessage.textContent = `Error: The Optional Employee ID "${employeeIdOptional}" is already in use and has a photo.`;
                enrollmentMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                enrollButton.disabled = false;
                enrollButton.textContent = 'Enroll Employee';
                return;
            } else {
                newSerialId = lastSerialId + 1;
                docId = String(newSerialId).padStart(6, '0'); 
            }

            try {
                // 1. Upload image to Firebase Storage 
                const fileExtension = photoFile.name.split('.').pop();
                const storagePath = `employee_photos/${appId}/${docId}.${fileExtension}`;
                
                const storageRef = ref(storage, storagePath);
                await uploadBytes(storageRef, photoFile);
                const photoURL = await getDownloadURL(storageRef);
                
                // 2. Prepare data for Firestore
                const employeeData = {
                    serialId: newSerialId, 
                    id: docId, 
                    employeeIdOptional: employeeIdOptional || 'N/A', 
                    englishName: englishName,
                    bengaliName: bengaliName,
                    designation: designation,
                    factoryName: factoryName,
                    nationalId: nationalId,
                    photoURL: photoURL, 
                    userId: userId,
                    // Use correct timestamp logic
                    ...(existingEmployee ? { updatedAt: serverTimestamp() } : { createdAt: serverTimestamp() }),
                };
                
                const employeeDocRef = doc(db, EMPLOYEE_COLLECTION_PATH, docId);
                
                await setDoc(employeeDocRef, employeeData, { merge: true });
                
                // Success feedback
                enrollmentMessage.textContent = `${action}: ${englishName || bengaliName} (Serial ID: ${docId})`;
                enrollmentMessage.className = 'mt-3 text-center text-sm font-medium text-green-600';
                document.getElementById('enrollmentForm').reset();
                document.getElementById('imagePreview').src = 'https://placehold.co/128x128/f3f4f6/9ca3af?text=Photo';

            } catch (error) {
                console.error("Single Enrollment failed:", error);
                enrollmentMessage.textContent = `Enrollment failed: ${error.message}`;
                enrollmentMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
            } finally {
                enrollButton.disabled = false;
                enrollButton.textContent = 'Enroll Employee';
            }
        }

        /**
         * Handles the bulk CSV file upload and processes records without photos.
         */
        window.handleBulkEnrollment = async function(event) {
            event.preventDefault();
            
            if (!['super_admin', 'admin'].includes(currentUserRole)) {
                bulkMessage.textContent = 'Permission denied. Only Admins can perform bulk enrollment.';
                bulkMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                return;
            }

            const csvFile = document.getElementById('csvFile').files[0];
            
            if (!csvFile) {
                bulkMessage.textContent = 'Please select a CSV file.';
                bulkMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                return;
            }

            bulkButton.disabled = true;
            bulkButton.textContent = 'Reading file...';
            bulkMessage.textContent = '';
            
            // Function to read the file
            const reader = new FileReader();
            reader.onload = async function(e) {
                const csvText = e.target.result;
                const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
                
                if (lines.length === 0) {
                    bulkMessage.textContent = 'The CSV file is empty.';
                    bulkMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                    bulkButton.disabled = false;
                    bulkButton.textContent = 'Process Bulk Data from CSV';
                    return;
                }
                
                bulkButton.textContent = `Processing ${lines.length} records...`;
                
                let successCount = 0;
                let failureCount = 0;
                
                // Skip the first line if it looks like a header (e.g., contains 'ID')
                const recordsToProcess = lines[0].toLowerCase().includes('id') ? lines.slice(1) : lines;

                for (const line of recordsToProcess) {
                    // Simple CSV parser: split by comma, trim whitespace
                    const parts = line.split(',').map(part => part.trim());
                    
                    if (parts.length < 5) {
                        console.warn(`Skipping line due to insufficient parts (expected 5 or 6, got ${parts.length}): ${line}`);
                        failureCount++;
                        continue;
                    }

                    const employeeIdOptional = parts[0]; 
                    const englishName = parts[1];
                    const bengaliName = parts[2];
                    const designation = parts[3];
                    const factoryName = parts[4];
                    const nationalId = parts.length > 5 ? parts[5] : ''; 
                    
                    if ((!englishName && !bengaliName) || !designation || !factoryName) {
                        console.warn(`Skipping line due to missing required data (Name EITHER/OR, Designation, or Factory): ${line}`);
                        failureCount++;
                        continue;
                    }
                    
                    // ID Generation: Use next available serial ID
                    let nextSerialId = lastSerialId + successCount + 1; 
                    const docId = String(nextSerialId).padStart(6, '0');
                    
                    // Check if the OPTIONAL ID already exists
                    if (employeeIdOptional && employees.some(e => e.employeeIdOptional === employeeIdOptional && e.photoURL !== 'N/A')) {
                         console.warn(`Skipping line: The Optional Employee ID "${employeeIdOptional}" is already in use with a photo.`);
                        failureCount++;
                        continue;
                    }

                    try {
                        const employeeData = {
                            serialId: nextSerialId,
                            id: docId, 
                            employeeIdOptional: employeeIdOptional || 'N/A', 
                            englishName: englishName,
                            bengaliName: bengaliName,
                            designation: designation,
                            factoryName: factoryName,
                            nationalId: nationalId,
                            photoURL: 'N/A', // Placeholder indicating photo is missing
                            createdAt: serverTimestamp(),
                            userId: userId,
                        };
                        
                        const employeeDocRef = doc(db, EMPLOYEE_COLLECTION_PATH, docId);
                        await setDoc(employeeDocRef, employeeData, { merge: true });
                        successCount++;
                    } catch (error) {
                        console.error(`Failed to bulk upload record for ID ${docId}:`, error);
                        failureCount++;
                    }
                }
                
                bulkButton.disabled = false;
                bulkButton.textContent = 'Process Bulk Data from CSV';
                document.getElementById('csvFile').value = ''; 
                
                const total = recordsToProcess.length;
                if (failureCount > 0) {
                    bulkMessage.textContent = `Bulk process complete: ${successCount}/${total} successful, ${failureCount} failed (check console for details/duplicates).`;
                    bulkMessage.className = 'mt-3 text-center text-sm font-medium text-orange-600';
                } else {
                    bulkMessage.textContent = `Bulk process successful! ${successCount} records added/updated without photos.`;
                    bulkMessage.className = 'mt-3 text-center text-sm font-medium text-green-600';
                }
            };

            reader.onerror = function() {
                bulkMessage.textContent = 'Error reading the file.';
                bulkMessage.className = 'mt-3 text-center text-sm font-medium text-red-600';
                bulkButton.disabled = false;
                bulkButton.textContent = 'Process Bulk Data from CSV';
            };

            reader.readAsText(csvFile);
        }


        // Start the application
        window.onload = initFirebase;
    </script>
</body>
</html>
